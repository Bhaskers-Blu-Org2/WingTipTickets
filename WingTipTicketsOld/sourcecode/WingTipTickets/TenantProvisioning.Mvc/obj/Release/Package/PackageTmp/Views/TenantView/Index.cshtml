@using System.Web.Services.Description
@model TenantProvisioning.Mvc.Models.TenantViewModel
@{
    ViewBag.Title = "Tenant";
}

<div class="row">
    <div class="col-xs-12">
        <h1>Welcome @Session["Username"]</h1>
    </div>
</div>

<div class="row spacer-25"> 
</div>

@if (Model.Companies.Any() && !Model.Companies[0].Status.Equals("Deployed"))
{
    <div class="alert alert-info" role="alert"> &nbsp;
        <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span><span class="sr-only"></span> &nbsp; Auto-provisioning takes approximately 16-20 mins to complete.
    </div>
}

<form class="form-horizontal">
    
    <div class="row row-underline">
        <div class="col-sm-12">
            <h3>Account Information</h3>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            
            <!-- -------------------------------------------------------------------------------------------------------------------------- -->
            <!-- TENANTS TABLE -->
            <!-- -------------------------------------------------------------------------------------------------------------------------- -->

            <table class="tenant-table">
                <tr class="row-underline">
                    <th>
                        THEME
                    </th>
                    <th>
                        PLAN
                    </th>
                    <th>
                        STATUS
                    </th>
                    <th>
                        
                    </th>
                </tr>

                @foreach (var tenant in Model.Companies)
                {
                    <tr>
                        <td>
                            @tenant.Theme
                        </td>
                        <td>
                            @tenant.Plan
                        </td>
                        <td id="TenantStatus">
                            @tenant.Status
                        </td>
                        <td class="text-right">
                            <span id="BtnServiceSection" class="glyphicon glyphicon-minus" onclick="expandCollapseSection()"></span>
                        </td>
                    </tr>

                    <tr id="TblServiceSection">
                        <td colspan="5">
                        
                            <!-- -------------------------------------------------------------------------------------------------------------------------- -->
                            <!-- TENANT SERVICE TABLE -->
                            <!-- -------------------------------------------------------------------------------------------------------------------------- -->

                            <table class="service-table">
                                <tr class="row-underline">
                                    <th>
                                        AZURE RESOURCE
                                    </th>
                                    <th>
                                        SERVICE NAME
                                    </th>
                                    <th>
                                        STATUS
                                    </th>
                                </tr>
                                
                                @foreach (var service in tenant.Services)
                                {
                                    <tr data-serviceId="@service.Id">
                                        <td class="service">
                                            @service.Service
                                        </td>
                                        <td class="name">
                                            @service.Name
                                        </td>
                                        <td class="status">
                                            <span id="Status_@service.Id" style="padding-right: 10px;" data-content="" onclick="showError('Status_@service.Id')" title="Click for more detail">
                                                @service.Status
                                            </span>
                                        </td>
                                    </tr>
                                }
                                
                                <!-- -------------------------------------------------------------------------------------------------------------------------- -->
                                <!-- TENANT ACTIONS -->
                                <!-- -------------------------------------------------------------------------------------------------------------------------- -->

                                <tr class="row-underline">
                                    <td colspan="3"></td>
                                </tr>
                                <tr>
                                    <td lass="text-left" style="padding: 10px;">
                                        @if (@tenant.Status.Equals("Deployed"))
                                        {
                                        <button id="TrafficManager" class="btn btn-info" type="button" onclick="trafficManager()">Go to Tenant Site</button>
                                        }
                                    </td>
                                    <td class="text-right" colspan="1" style="padding: 10px;">
                                        
                                    </td>
                                    <td class="text-right" colspan="1" style="padding: 10px;">
                                        <button id="DeleteTenant" class="btn btn-info" type="button" onclick=" deprovisionServices() ">Delete Resources and Start Over</button>
                                    </td>
                                </tr>
                            </table>
                        </td> 
                    </tr>
                }
            </table>
        </div>
    </div>

</form>

<form>
    <button id="RetryTenant" class="btn btn-info" type="button" onclick="location.reload();">Retry Deployment</button>
 </form>

<!-- -------------------------------------------------------------------------------------------------------------------------- -->
<!-- SCRIPTS -->
<!-- -------------------------------------------------------------------------------------------------------------------------- -->

@section scripts {
    <script type="text/javascript">

        var _intervalId;
        var _provisioning = false;
        var _errorsOccurred = false;

        $(document).ready(function()
        {
            // Check if tenant has been provisioned
            if ("@Model.Companies[0].AzureServicesProvisioned" == "False")
            {
                provisionServices();
            }
        });

        function provisionServices()
        {
            // If not already running, start provisioning
            if (!_provisioning)
            {
                _errorsOccurred = false;

                $.ajax({
                    type: "GET",
                    url: "@Url.Action("ProvisionTenantSite", "TenantView")",
                    async: false,
                    data: { tenantId: @Model.Companies[0].Id },
                    dataType: 'json',
                    cache: false
                }).done(function(data)
                {
                    // Start status updates
                    updateStatusses(provisionServicesCompleted);
                });

                _provisioning = true;
            }
        }
        
        function provisionServicesCompleted()
        {
            // Clear interval
            _provisioning = false;
            clearInterval(_intervalId);

            if (!_errorsOccurred)
            {
                location.reload();
            }
        }

        function deprovisionServices()
        {
            // Confirm the Delete
            $('#confirmationMessage').html('Are you sure you want to <strong>DELETE</strong> this deployment?');
            $('#confirmYes').click(function()
            {
                _errorsOccurred = false;

                // Hide the Model
                $('#confirmModel').modal('hide');

                // Disable the Button
                $("#DeleteTenant").prop('disabled', true);

                // Update the Tenant Status
                $("#TenantStatus").html("Removing");

                // DeprovisionComponent the tenant services
                $.ajax({
                    type: "GET",
                    url: "@Url.Action("DeprovisionTenantSite", "TenantView")",
                    async: false,
                    data: { tenantId: @Model.Companies[0].Id },
                    dataType: 'json',
                    cache: false
                }).done(function(data)
                {
                    // Start status updates
                    updateStatusses(deprovisionServicesCompleted);
                });
            });

            $('#confirmModel').modal({
                backdrop: 'static'
            });
        }

        function trafficManager()
        {
            var form = document.createElement("form");
            form.method = "GET";
            form.action = "http://" + '@Model.Companies[0].Services.First(x => x.Service == "Traffic Manager").Name' + ".trafficmanager.net";
            form.target = "_blank";

            document.body.appendChild(form);

            form.submit();
        }

        function deprovisionServicesCompleted()
        {
            // Show Alert
            $('#alertMessage').html('Deployment has been deleted successfully');
            $('#alertDismiss').click(function()
            {
                // Hide the Model
                $('#alertModel').modal('hide');

                // Clear interval, log out and delete user account
                clearInterval(_intervalId);
                document.location = "@Url.Action("SignOut", "Account", new { deleteTenant=true, tenantId=@Model.Companies[0].Id })";
            });

            $('#alertModel').modal({
                backdrop: 'static'
            });
        }

        function updateStatusses(callbackFunction)
        {
            // Update the Statusses at a 2 second interval
            _intervalId = setInterval(function()
            {
                $.ajax({
                    type: "GET",
                    url: "@Url.Action("GetStatusses", "TenantView")",
                    async: false,
                    dataType: 'json',
                    cache: false
                }).done(function(data)
                {
                    // Update the Status column
                    for (var i = 0; i < data.Result.Statusses.length; i++)
                    {
                        var serviceRow = $("[data-serviceId='" + data.Result.Statusses[i].Id + "'");
                        var status = serviceRow.children("td.status").children('span');

                        // Set the error Message if Failed
                        if (data.Result.Statusses[i].Status == 'Error' || data.Result.Statusses[i].Status == 'Warning')
                        {
                            status.addClass("field-validation-error");
                            status.attr("data-content", data.Result.Statusses[i].Message);
                        } else
                        {
                            status.removeClass("field-validation-error");
                            status.attr("data-content", "");
                        }

                        // Set the Status Message
                        status.html(data.Result.Statusses[i].Status);
                    };

                    // Check for Errors
                    if (data.Result.ErrorsOccurred)
                    {
                        _errorsOccurred = true;
                    }

                    // Run callback function if Completed
                    if (data.Result.Completed)
                    {
                        if (callbackFunction)
                        {
                            callbackFunction();
                        }
                    }
                });
            }, 2000);
        }

        function expandCollapseSection()
        {
            // Expand and collapse the service section
            $("#TblServiceSection").toggle();

            var button = $("#BtnServiceSection");

            if (button.hasClass("glyphicon-plus"))
            {
                button.addClass("glyphicon-minus");
                button.removeClass("glyphicon-plus");
            } else
            {
                button.addClass("glyphicon-plus");
                button.removeClass("glyphicon-minus");
            }
        }

        function showError(name)
        {
            var elem = $("#" + name);
            var value = elem.attr("data-content");

            if (value != '')
            {
                // Show Alert
                $('#alertMessage').html(value);
                $('#alertDismiss').click(function()
                {
                    // Hide the Model
                    $('#alertModel').modal('hide');
                });

                $('#alertModel').modal({
                    backdrop: 'static'
                });
            }
        }

    </script>
}