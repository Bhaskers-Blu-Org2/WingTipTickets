@model TenantProvisioning.Mvc.Models.TenantViewModel
@{
    ViewBag.Title = "Admin";
}

<div class="row">
    <div class="col-xs-12">
        <h1>Welcome @Session["Username"]</h1>
    </div>
</div>

<div class="row spacer-25"> 
</div>

<form class="form-horizontal">
    
    <div class="row row-underline">
        <div class="col-sm-6">
            <h3>Account Information</h3>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            
            <!-- -------------------------------------------------------------------------------------------------------------------------- -->
            <!-- COMPANIES TABLE -->
            <!-- -------------------------------------------------------------------------------------------------------------------------- -->

            <table class="tenant-table">
                <tr class="row-underline">
                    <th>
                        THEME
                    </th>
                    <th>
                        PLAN
                    </th>
                    <th>
                        STATUS
                    </th>
                    <th>
                        
                    </th>
                </tr>
                
                @foreach (var tenant in Model.Companies)
                {
                    <tr>
                        <td>
                            @tenant.Theme
                        </td>
                        <td>
                            @tenant.Plan
                        </td>
                        <td id="TenantStatus_@tenant.Id">
                            @tenant.Status
                        </td>
                        <td class="text-right">
                            <span id="BtnServiceSection_@tenant.Id" class="glyphicon glyphicon-plus" onclick="expandCollapseSection(@tenant.Id)"></span>
                        </td>
                    </tr>

                    <tr id="TblServiceSection_@tenant.Id" style="display: none">
                        <td colspan="5">
                            
                            <!-- -------------------------------------------------------------------------------------------------------------------------- -->
                            <!-- COMPANY SERVICES TABLE -->
                            <!-- -------------------------------------------------------------------------------------------------------------------------- -->

                            <table class="service-table">
                                <tr class="row-underline">
                                    <th>
                                        AZURE RESOURCE
                                    </th>
                                    <th>
                                        SERVICE NAME
                                    </th>
                                    <th>
                                        STATUS
                                    </th>
                                </tr>

                                @foreach (var service in tenant.Services)
                                {
                                    <tr data-serviceid="@tenant.Id-@service.Id">
                                        <td class="service">
                                            @service.Service
                                        </td>
                                        <td class="name">
                                            @service.Name
                                        </td>
                                        <td class="status">
                                            @service.Status
                                        </td>
                                    </tr>
                                }
                                
                                <!-- -------------------------------------------------------------------------------------------------------------------------- -->
                                <!-- COMPANY ACTIONS -->
                                <!-- -------------------------------------------------------------------------------------------------------------------------- -->

                                <tr class="row-underline">
                                    <td colspan="3"></td>
                                </tr>
                                <tr>
                                    <td class="text-right" colspan="3" style="padding: 10px;">
                                        <button id="DeleteTenant_@tenant.Id" class="btn btn-info" type="button" onclick="deprovisionServices(@tenant.Id)">Delete Tenant Account</button>
                                    </td>
                                </tr>
                            </table>

                        </td>
                    </tr>
                }

            </table>
        </div>
    </div>

</form>

<!-- -------------------------------------------------------------------------------------------------------------------------- -->
<!-- SCRIPTS -->
<!-- -------------------------------------------------------------------------------------------------------------------------- -->

@section scripts {
    <script type="text/javascript">

    var _intervalId;

    $(document).ready(function()
    {
    });

    function deprovisionServices(tenantId)
    {
        // Confirm the Delete
        $('#confirmationMessage').html('Are you sure you want to <strong>DELETE</strong> this account?');
        $('#confirmYes').click(function()
        {
            // Hide the Model
            $('#confirmModel').modal('hide');
            
            // Disable the Button
            $("#DeleteTenant").prop('disabled', true);

            // Update the Tenant Status
            $("#TenantStatus_" + tenantId).html("Removing");

            // DeprovisionComponent the tenant services
            $.ajax({
                type: "GET",
                url: "@Url.Action("DeprovisionTenantSite", "AdminView")",
                async: false,
                data: { tenantId: tenantId },
                dataType: 'json',
                cache: false
            }).done(function(data)
            {
                // Start status updates
                updateStatusses(tenantId);
            });
        });

        $('#confirmModel').modal({
            backdrop: 'static'
        });
    }

    function updateStatusses(tenantId)
    {
        // Disable the Button
        $("#DeleteTenant_" + tenantId).prop('disabled', true);

        // Update the Statusses at a 2 second interval
        _intervalId = setInterval(function()
        {
            $.ajax({
                type: "GET",
                url: "@Url.Action("GetStatusses", "AdminView")",
                async: false,
                dataType: 'json',
                cache: false
            }).done(function(data)
            {
                // Update the Status column
                for (var i = 0; i < data.Result.Statusses.length; i++)
                {
                    var serviceRow = $("[data-serviceId='" + tenantId + "-" + data.Result.Statusses[i].Id + "'");

                    var status = serviceRow.children("td.status");

                    status.html(data.Result.Statusses[i].Status);
                };

                // Run callback function if Completed
                if (data.Result.Completed)
                {
                    clearInterval(_intervalId);

                    // Delete the Account
                    $.ajax({
                        type: "GET",
                        url: "@Url.Action("DeleteAccount", "AdminView")",
                            async: false,
                            data: { tenantId: tenantId },
                            dataType: 'json',
                            cache: false
                    }).done(function()
                    {
                        document.location = "@Url.Action("Index", "AdminView")";
                    });
                }
            });
        }, 2000);
    }

    function expandCollapseSection(tenantId) {
        // Expand and collapse the service section
        $("#TblServiceSection_" + tenantId).toggle();

        var button = $("#BtnServiceSection_" + tenantId);

        if (button.hasClass("glyphicon-plus"))
        {
            button.addClass("glyphicon-minus");
            button.removeClass("glyphicon-plus");
        } else
        {
            button.addClass("glyphicon-plus");
            button.removeClass("glyphicon-minus");
        }
    }

    </script>
}